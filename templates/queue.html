{% extends "base.html" %}

{% block content %}
  <h1>Queue</h1>
  <section>
    <h2>Flagged Threads</h2>
    {% if threads and threads|length > 0 %}
      <ul>
        {% for thread in threads %}
          <li>
            <a href="{{ url_for('main.queue_detail', thread_pk=thread.thread_pk) }}">
              {{ thread.title or "(untitled)" }}
            </a>
            {% if thread.subreddit %}
              — r/{{ thread.subreddit }}
            {% endif %}
            {% if thread.latest_draft_text %}
              <div>{{ thread.latest_draft_text|truncate(160, True) }}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No flagged threads yet.</p>
    {% endif %}
  </section>

  <section>
    <h2>Thread Detail</h2>
    {% if selected %}
      <article>
        <h3>{{ selected.thread.title or "(untitled)" }}</h3>
        <p>
          {{ selected.thread.source }}
          {% if selected.thread.subreddit %}
            • r/{{ selected.thread.subreddit }}
          {% endif %}
          {% if selected.thread.created_at_utc %}
            • {{ selected.thread.created_at_utc }}
          {% endif %}
        </p>
        {% if selected.thread.url %}
          <p>
            <a href="{{ selected.thread.url }}">Open original thread</a>
          </p>
        {% endif %}
        {% if selected.thread.body %}
          <pre>{{ selected.thread.body }}</pre>
        {% endif %}
      </article>

      <section>
        <h3>Comments</h3>
        {% if selected.comments and selected.comments|length > 0 %}
          <ul>
            {% for comment in selected.comments %}
              <li>
                {% if comment.author %}
                  <strong>{{ comment.author }}</strong>:
                {% endif %}
                <span>{{ comment.body }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No comments yet.</p>
        {% endif %}
      </section>

      <section>
        <h3>Latest Draft</h3>
        <form method="post" action="{{ url_for('main.save_draft', thread_pk=selected.thread.thread_pk) }}">
          <textarea id="draft-text" name="draft_text" rows="8" cols="80">{{ selected.latest_draft.draft_text if selected.latest_draft else "" }}</textarea>
          <div>
            <button type="submit">Save</button>
            <button type="button" id="copy-draft">Copy</button>
          </div>
        </form>
        {% if not selected.latest_draft %}
          <p>No draft response yet.</p>
        {% endif %}
      </section>

      <section>
        <h3>GenAI Notes</h3>
        {% if selected.latest_genai_eval %}
          {% if selected.latest_genai_eval.short_reason %}
            <p>{{ selected.latest_genai_eval.short_reason }}</p>
          {% else %}
            <p>No short reason provided.</p>
          {% endif %}
        {% else %}
          <p>No GenAI evaluation yet.</p>
        {% endif %}
      </section>

      {% if selected.detections and selected.detections|length > 0 %}
        <section>
          <h3>Detections</h3>
          <ul>
            {% for detection in selected.detections %}
              <li>{{ detection.detection_type }} — {{ detection.evidence_text }}</li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}

      {% if selected.rule_hits and selected.rule_hits|length > 0 %}
        <section>
          <h3>Recent Rule Hits</h3>
          <ul>
            {% for hit in selected.rule_hits %}
              <li>
                {{ hit.matched_term }} ({{ hit.match_context }}) — {{ hit.created_at_utc }}
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}
    {% elif not_found %}
      <p>Thread not found.</p>
    {% else %}
      <p>Select a thread to review.</p>
    {% endif %}
  </section>
  <script>
    const copyButton = document.getElementById("copy-draft");
    if (copyButton) {
      copyButton.addEventListener("click", () => {
        const textArea = document.getElementById("draft-text");
        if (textArea) {
          navigator.clipboard.writeText(textArea.value);
        }
      });
    }
  </script>
{% endblock %}
